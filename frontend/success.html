<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Successful - ClassGuru</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Background with gradient halos -->
  <div class="cg-background" aria-hidden="true">
    <div class="cg-halo cg-halo--one"></div>
    <div class="cg-halo cg-halo--two"></div>
    <div class="cg-halo cg-halo--three"></div>
  </div>

  <div class="cg-template">
    <!-- Header -->
    <header class="cg-header">
      <div class="cg-brand">
        <div class="cg-logo">CG</div>
        <div class="cg-brand-text">
          <h1>ClassGuru</h1>
          <p>AI-Powered Learning</p>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="cg-content">
      <div class="result-container">
        <!-- Success Card -->
        <div class="cg-card text-center">
          <!-- Success Icon -->
          <div class="result-icon success">
            <span>✓</span>
          </div>

          <!-- Success Message -->
          <h1 class="result-title">Payment Successful!</h1>
          <p class="result-message">
            Thank you for subscribing to ClassGuru. Your payment has been processed successfully.
          </p>

          <!-- Order Details -->
          <div class="order-details">
            <div class="detail-row">
              <span class="detail-label">Order ID:</span>
              <span class="detail-value" id="order-id">Loading...</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Session ID:</span>
              <span class="detail-value" id="session-id">Loading...</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Plan:</span>
              <span class="detail-value" id="plan-name">Loading...</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Status:</span>
              <span class="detail-value" style="color: var(--cg-success); font-weight: 600;">Completed</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <a href="/payment" class="cg-button secondary">
              Back to Plans
            </a>
            <a href="https://classguru.ai/dashboard" class="cg-button primary">
              Go to Dashboard
            </a>
          </div>

          <!-- Additional Info -->
          <div class="mt-32 text-center" style="color: var(--cg-muted); font-size: 0.9rem;">
            <p style="margin-bottom: 8px;">A confirmation email has been sent to your registered email address.</p>
            <p class="mb-0">If you have any questions, please contact our support team.</p>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="cg-footer">
      <span>© 2025 ClassGuru. All rights reserved.</span>
    </footer>
  </div>

  <script>
    // Simple script to load order information for success page
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[SUCCESS] Loading order information...');
      
      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const sessionIdFromUrl = urlParams.get('session_id');
      
      // Get stored order information
      const orderId = localStorage.getItem('cg_last_order_id');
      const sessionId = localStorage.getItem('cg_last_session_id') || sessionIdFromUrl;
      const planType = localStorage.getItem('cg_last_plan_type');
      
      console.log('[SUCCESS] Order data:', { orderId, sessionId, planType });
      
      // Try to fetch order details from server
      if (sessionId) {
        try {
          const response = await fetch(`http://localhost:8790/api/payment/status/${sessionId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const responseData = await response.json();
            console.log('[SUCCESS] Server response:', responseData);
            
            const data = responseData.data || {};
            
            // Update order details
            document.getElementById('order-id').textContent = data.order_id || orderId || 'Not available';
            document.getElementById('session-id').textContent = data.session_id || sessionId || 'Not available';
            
            // Format plan name
            let planDisplayName = 'Unknown Plan';
            if (data.plan) {
              if (data.plan.includes('monthly-plan')) {
                planDisplayName = 'Monthly Plan';
              } else if (data.plan.includes('weekly-plan')) {
                planDisplayName = 'Weekly Plan';
              } else if (data.plan.includes('daily-plan')) {
                planDisplayName = 'Daily Plan';
              } else {
                planDisplayName = data.plan;
              }
            } else if (planType) {
              planDisplayName = planType;
            }
            document.getElementById('plan-name').textContent = planDisplayName;
            
            console.log('[SUCCESS] Order details updated successfully');
          } else {
            console.warn('[SUCCESS] Failed to fetch order details from server');
            // Fallback to stored data
            document.getElementById('order-id').textContent = orderId || 'Not available';
            document.getElementById('session-id').textContent = sessionId || 'Not available';
            document.getElementById('plan-name').textContent = planType || 'Unknown Plan';
          }
        } catch (error) {
          console.error('[SUCCESS] Error fetching order details:', error);
          // Fallback to stored data
          document.getElementById('order-id').textContent = orderId || 'Not available';
          document.getElementById('session-id').textContent = sessionId || 'Not available';
          document.getElementById('plan-name').textContent = planType || 'Unknown Plan';
        }
      } else {
        // No session ID, use stored data
        document.getElementById('order-id').textContent = orderId || 'Not available';
        document.getElementById('session-id').textContent = 'Not available';
        document.getElementById('plan-name').textContent = planType || 'Unknown Plan';
      }
      
      // Clear stored data after displaying
      localStorage.removeItem('cg_last_order_id');
      localStorage.removeItem('cg_last_session_id');
      localStorage.removeItem('cg_last_plan_type');
      console.log('[SUCCESS] Cleared stored payment data');
    });
  </script>
</body>
</html>
